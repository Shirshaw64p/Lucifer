#!/usr/bin/env python3
"""Quick script to kick off a Lucifer pentest run via the API."""

import json
import sys
import urllib.request
import urllib.error

BASE = "http://localhost:8080/api/v1"

def api(method, path, data=None, token=None):
    headers = {"Content-Type": "application/json"}
    if token:
        headers["Authorization"] = f"Bearer {token}"
    body = json.dumps(data).encode() if data else None
    req = urllib.request.Request(f"{BASE}{path}", data=body, headers=headers, method=method)
    try:
        resp = urllib.request.urlopen(req, timeout=10)
        return json.loads(resp.read())
    except urllib.error.HTTPError as e:
        print(f"HTTP {e.code}: {e.read().decode()}")
        sys.exit(1)
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)

# 1. Login
print("=== Step 1: Login ===")
auth = api("POST", "/auth/login", {"username": "admin", "password": "admin"})
token = auth["access_token"]
print(f"  JWT obtained: {token[:40]}...")

# 2. Create a run
print("\n=== Step 2: Create pentest run ===")
run = api("POST", "/runs", {
    "name": "Demo Pentest Run",
    "config": {},
    "targets": [
        {"target_type": "url", "value": "https://example.com", "in_scope": True},
        {"target_type": "domain", "value": "example.com", "in_scope": True},
    ]
}, token)
run_id = run["id"]
print(f"  Run created: {run_id}")
print(f"  Status: {run['status']}")
print(f"  Targets: {len(run.get('targets', []))}")

# 3. Start the run
print("\n=== Step 3: Start the run ===")
started = api("POST", f"/runs/{run_id}/start", token=token)
print(f"  Status: {started['status']}")
print(f"  Run ID: {started['id']}")

print(f"\n=== Pentest run is now ACTIVE ===")
print(f"  Dashboard:  http://localhost:5173/runs/{run_id}")
print(f"  API Detail: http://localhost:8080/api/v1/runs/{run_id}")
print(f"  Swagger UI: http://localhost:8080/docs")
